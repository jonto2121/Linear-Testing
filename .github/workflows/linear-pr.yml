name: Linear Integration

on:
  pull_request:
    types: [opened, closed]

jobs:
  linear-integration:
    runs-on: ubuntu-latest
    steps:
      # Create issue when PR is opened
      - name: Create Linear Issue
        if: github.event.action == 'opened'
        shell: bash
        run: |
          # Extract PR info
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          echo "Creating Linear issue for PR #${PR_NUMBER}: ${PR_TITLE}"
          
          # Format description (escape for JSON)
          DESCRIPTION="## GitHub PR Details\n**PR:** [#${PR_NUMBER}: ${PR_TITLE}](${PR_URL})\n**Author:** ${PR_AUTHOR}\n\n${PR_BODY}"
          
          # Create Linear issue via API using curl with correct teamId field
          RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -d "{\"query\":\"mutation CreateIssue(\$title: String!, \$description: String!, \$teamId: String!) { issueCreate(input: { title: \$title, description: \$description, teamId: \$teamId }) { success issue { id identifier url } } }\",\"variables\":{\"title\":\"[PR] ${PR_TITLE}\",\"description\":\"${DESCRIPTION}\",\"teamId\":\"${{ secrets.LINEAR_TEAM_ID }}\"}}")
          
          echo "Linear API response: $RESPONSE"
          
          # Extract issue identifier and URL using grep and sed
          ISSUE_IDENTIFIER=$(echo $RESPONSE | grep -o '"identifier":"[^"]*"' | sed 's/"identifier":"//;s/"//')
          ISSUE_URL=$(echo $RESPONSE | grep -o '"url":"[^"]*"' | sed 's/"url":"//;s/"//')
          ISSUE_ID=$(echo $RESPONSE | grep -o '"id":"[^"]*"' | sed 's/"id":"//;s/"//')
          
          echo "Extracted information:"
          echo "Issue Identifier: $ISSUE_IDENTIFIER"
          echo "Issue URL: $ISSUE_URL"
          echo "Issue ID: $ISSUE_ID"
          
          if [ ! -z "$ISSUE_IDENTIFIER" ]; then
            echo "Linear issue created: $ISSUE_IDENTIFIER ($ISSUE_URL)"
            
            # Add comment to PR with issue info
            PR_COMMENT_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
            curl -s -X POST $PR_COMMENT_URL \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"body\":\"✅ Linear issue created: [${ISSUE_IDENTIFIER}](${ISSUE_URL})\"}"
            
            # Add label with Linear issue ID to PR
            PR_LABEL_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels"
            curl -s -X POST $PR_LABEL_URL \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"labels\":[\"linear-issue:${ISSUE_ID}\"]}"
              
            echo "Added label with Linear issue ID to PR"
          else
            echo "Failed to create Linear issue"
            exit 1
          fi

      # Update issue status when PR is merged
      - name: Update Linear Issue Status
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        shell: bash
        run: |
          echo "PR has been merged, updating Linear issue status"
          
          # Get PR labels to find the Linear issue ID
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # Extract Linear issue ID directly from event payload labels
          ISSUE_ID=""
          
          # Loop through labels to find linear-issue label
          echo "Checking labels on PR #${PR_NUMBER}"
          echo "Labels: ${{ toJSON(github.event.pull_request.labels) }}"
          
          for label in $(echo "${{ toJSON(github.event.pull_request.labels) }}" | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//')
          do
            echo "Checking label: $label"
            if [[ $label == linear-issue:* ]]; then
              ISSUE_ID=${label#linear-issue:}
              echo "Found Linear issue ID in label: $ISSUE_ID"
              break
            fi
          done
          
          # If not found in payload, try API call to get labels
          if [ -z "$ISSUE_ID" ]; then
            echo "Linear issue ID not found in payload, fetching from API"
            LABELS_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/labels"
            
            LABELS=$(curl -s -X GET $LABELS_URL \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json")
              
            echo "Labels response: $LABELS"
            
            for label in $(echo "$LABELS" | grep -o '"name":"[^"]*"' | sed 's/"name":"//;s/"//')
            do
              if [[ $label == linear-issue:* ]]; then
                ISSUE_ID=${label#linear-issue:}
                echo "Found Linear issue ID in API labels: $ISSUE_ID"
                break
              fi
            done
          fi
          
          # If still not found, try to search in past API activity
          if [ -z "$ISSUE_ID" ]; then
            echo "Linear issue ID not found in labels, trying to find in PR timeline"
            TIMELINE_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/timeline"
            
            TIMELINE=$(curl -s -X GET $TIMELINE_URL \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Content-Type: application/json")
              
            echo "Timeline data (first 300 chars): ${TIMELINE:0:300}..."
            
            # Extract issue ID from timeline events (looking for comments or label additions)
            # This is a fallback and might not be reliable
            ISSUE_ID=$(echo "$TIMELINE" | grep -o 'Linear issue created: \[[^]]*\]([^)]*)' | head -1 | sed 's/.*\///' | sed 's/-.*$//')
            
            if [ ! -z "$ISSUE_ID" ]; then
              echo "Found Linear issue ID in timeline: $ISSUE_ID"
            fi
          fi
          
          if [ -z "$ISSUE_ID" ]; then
            echo "Could not find Linear issue ID for this PR"
            exit 1
          fi
          
          echo "Found Linear issue ID: $ISSUE_ID"
          
          # Get the ID of the "Done" state for your team
          echo "Fetching workflow states for team ${{ secrets.LINEAR_TEAM_ID }}"
          
          STATES_QUERY=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -d "{\"query\":\"{ workflowStates(filter: { team: { id: { eq: \\\"${{ secrets.LINEAR_TEAM_ID }}\\\" } } }) { nodes { id name type } } }\"}")
          
          echo "Workflow states response: $STATES_QUERY"
          
          # Extract the "Done" state ID
          DONE_STATE_ID=$(echo "$STATES_QUERY" | grep -o '"id":"[^"]*","name":"Done"' | head -1 | sed 's/"id":"//;s/","name":"Done"//')
          
          echo "First attempt to find Done state ID: '$DONE_STATE_ID'"
          
          if [ -z "$DONE_STATE_ID" ]; then
            echo "Trying to find any completed state"
            # Try to find any completed state if "Done" isn't found
            DONE_STATE_ID=$(echo "$STATES_QUERY" | grep -o '"id":"[^"]*","name":"[^"]*","type":"completed"' | head -1 | sed 's/.*"id":"//;s/","name.*//')
            echo "Found completed state ID: '$DONE_STATE_ID'"
          fi
          
          if [ -z "$DONE_STATE_ID" ]; then
            echo "Could not find 'Done' state ID for your team"
            echo "Full workflow states data: $STATES_QUERY"
            exit 1
          fi
          
          echo "Found 'Done' state ID: $DONE_STATE_ID"
          
          # Update the Linear issue status to "Done"
          echo "Updating Linear issue $ISSUE_ID to state $DONE_STATE_ID"
          
          UPDATE_RESPONSE=$(curl -s -X POST https://api.linear.app/graphql \
            -H "Content-Type: application/json" \
            -H "Authorization: ${{ secrets.LINEAR_API_KEY }}" \
            -d "{\"query\":\"mutation UpdateIssue(\$issueId: String!, \$stateId: String!) { issueUpdate(id: \$issueId, input: { stateId: \$stateId }) { success issue { id identifier state { name } } } }\",\"variables\":{\"issueId\":\"${ISSUE_ID}\",\"stateId\":\"${DONE_STATE_ID}\"}}")
          
          echo "Update response: $UPDATE_RESPONSE"
          
          SUCCESS=$(echo "$UPDATE_RESPONSE" | grep -o '"success":true')
          if [ ! -z "$SUCCESS" ]; then
            echo "Successfully updated Linear issue status to Done"
            
            # Add comment to PR
            PR_COMMENT_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"
            curl -s -X POST $PR_COMMENT_URL \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"body\":\"✅ Linear issue marked as Done\"}"
          else
            echo "Failed to update Linear issue status"
            exit 1
          fi
